# Container numbers recognition service
	Задача распознать надпись на движущемся контейнере 

## Обзор решения

Распознавание номеров контейнеров происходит с помощью трёх независимых архитектур:
[YOLOv5](https://github.com/ultralytics/yolov5), [CRAFT](https://github.com/clovaai/CRAFT-pytorch), [ResNet](https://pytorch.org/hub/pytorch_vision_resnet/).


1. YOLOv5 используется для определения бокса с номером контейнера на исходном изображении (снимок с боковой камеры).
2. CRAFT находит боксы с отдельными символами на изображении, обрезанном на оснований предсказаний YOLO.
3. ResNet используется для классификации изображений каждого отдельного символа.


## Структура репозитория

* [check_service.ipynb](check_service.ipynb/) - проверка работы сервиса
* [weights](weights/) - веса обученной модели, модель resnet_symbols.pt свыше 100 Мб, что превышает ограничение гита
* [craft](craft/) - модуль распознавания символов: https://github.com/clovaai/CRAFT-pytorch
* [yolo](yolo/) - модуль детекции боксов, используется через torch hub: https://github.com/ultralytics/yolov5/issues/36
* [detect.py](detect.py/) - основной скрипт всего пайплайна. 
* [test.py](test.py/) - скрипт для снятия метрик модели с изображений: фотографии контейнеров, скриншоты с камер и т.д.
* [test_video.py](test_video.py/) - скрипт для снятия метрик с видео. Одно видео должно содержать только один проезжающий контейнер.
* [web_app.py](web_app.py/) - flask сервис. 
* [exp](exp/) - эксперименты с поиском бокса. 


## REST Сервис

Запуск - `python web_app.py`

Тестовое отправление запросов - `check_service.ipynb`

По умолчанию сервис запускается на `127.0.0.1:6000/` и ожидает получения отдельных кадров видео.
Обработка одного кадра занимает около 200мс, в связи с чем не следует отправлять каждый кадр видео, а выбрать раз в сколько кадров будет происходить предсказание. 

Перед отправкой кадров, необходимо отправить **POST** на `/switch` с параметром `mode='start'`.

Сервис ожидает:

1. Одномерный массив полученный из 8-битного трехканального изображения с ключом `"videoframe"`
2. Form-data[`"width"`]: ширина изображения
3. Form-data[`"height"`]: высота изображения

Сервис возвращает json в формате:

```
{'result':
    {
    'box':координаты бокса в формате xyxy,
    'current_number':распознанный номер контейнера,
    'score':уверенность в найденном боксе
    },
'latency_ms':время отработки сервиса,
'message':сообщение,
'is_error':ошибочен ли запрос}
```

По завершению детекции одного контейнера, необходимо отправить **POST** на `/switch` с параметром `mode='stop'`. Сервис вернет финальное предсказание номера на основе всех предыдущих кадров в формате:

```
{'result':
    {    
    'final_number':объединенный номер контейнера,    
    },
'message':сообщение,
'is_error':ошибочен ли запрос}
```

## Установка

`pip install -r requirements.txt`